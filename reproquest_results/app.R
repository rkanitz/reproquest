# settings ####
set.seed(1)

library(tidyverse)
library(shinythemes)
library(janitor)
library(shiny)
library(ggraph)
library(igraph)

source("R/functions.R")

#####

# Define UI
ui <- fluidPage(
  theme = shinytheme("united"),
                 
  # Application title
  titlePanel("Welcome to the Quest survey results!"),
  
  tags$head(tags$style('ul.nav.nav-tabs { margin-bottom: 2rem }')),
  
  tabsetPanel(
  #   tabPanel("Welcome!",
  #            h3("Thank you for playing this quiz game with us! In a minute we will show some results from the survey."),
  #            imageOutput("survey"),
  #            br(),
  #            br(),
  #            br(),
  #            # "Use the field below to import your data.",
  #            fileInput('file', 'Upload csv file'), # fileInput("file",NULL, buttonLabel="Upload...", accept = ".csv")
  #            uiOutput('date'),
  #            uiOutput('time'),
  #            tableOutput("data")
  #   ),
    
    tabPanel("Tree of possibilities",
             
             h3('Tree of answers generated by you playing this game.'),
             plotOutput('plt_dendro_filtered', height = '700px')
    )
    
  )
)


server <- function(input, output, session) {
  
  data <- reactive({
    d <- prepare_survey_coffee("data/coffee_survey1.csv", skinny = FALSE)
    d$time <- as.character(d$time)
    
    # check if there are duplicated names and fix it
    n_occur <- data.frame(table(d$nickname))
    dupl_name <- n_occur[n_occur$Freq > 1,]
    
    for (i in 1:nrow(dupl_name)) {
      row_id <- which(d$nickname == dupl_name$Var1[i])
      create_unique <- as.character(dupl_name[i,"Var1"])
      create_unique <- paste(create_unique, c(1:length(row_id)), sep="_")
      
      d$nickname[row_id] <- create_unique
    }
    
    d
    # d <- readr::read_csv(input$file$datapath)
    # dplyr::mutate(d, date = as.Date(`Date Taken (Europe/Zurich)`, format='%m/%d/%Y'), # readr does not read this as a date
    #               time = format(`Time Taken (Europe/Zurich)`, "hhmmss"), # this makes it a character. readr already reads it as a time, in this case
    #               nickname = `Q1 - Choose a nickname`) %>%
    #   dplyr::select(-`Unique ID`, -Email, -Browser, -OS, -`Date Taken (Europe/Zurich)`, -`Time Taken (Europe/Zurich)`)
  }) # this stays in the server
  
 
  
  output$plt_dendro_filtered <- renderPlot({
    plt_dendro(data())
  })
  
}


# Run the application 
shinyApp(ui = ui, server = server)
